<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <!-- favicon将通过JavaScript动态设置 -->
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Naive UI -->
    <script src="https://unpkg.com/naive-ui@2.39.0/dist/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vfonts/Lato.css">
    <link rel="stylesheet" href="https://unpkg.com/vfonts/FiraCode.css">
    <style>
        body {
            margin: 0;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: background 0.5s ease;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px 20px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .header-card {
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .avatar-container {
            flex-shrink: 0;
        }

        .streamer-info {
            flex: 1;
        }

        .streamer-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-size: 2.2rem;
            font-weight: bold;
            line-height: 1.2;
        }

        .stats-container {
            display: flex;
            gap: 25px;
            margin-top: 12px;
        }

        .controls-card {
            margin-bottom: 20px;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .song-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .song-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .song-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.1rem;
            color: #666;
        }

        .floating-actions {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 30px 16px 16px 16px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .streamer-title {
                font-size: 1.8rem;
            }

            .stats-container {
                justify-content: center;
                gap: 20px;
            }

            .controls-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .song-list {
                grid-template-columns: 1fr;
            }

            .floating-actions {
                bottom: 16px;
                right: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <n-config-provider :theme="theme" :theme-overrides="themeOverrides">
            <n-message-provider>
                <app-content />
            </n-message-provider>
        </n-config-provider>
    </div>

    <script>
        const { createApp } = Vue;
        const { 
            NConfigProvider, 
            NCard, 
            NAvatar, 
            NText, 
            NStatistic, 
            NButton, 
            NIcon, 
            NInput, 
            NTag, 
            NThing, 
            NSpace, 
            NEmpty, 
            NBackTop, 
            NModal, 
            NPagination,
            useMessage,
            darkTheme 
        } = naive;

        const AppContent = {
            template: `
                <div class="main-container">
                    <!-- 用户信息头部 -->
                    <n-card class="header-card" :bordered="false">
                        <div class="header-content">
                            <div class="avatar-container">
                                <n-avatar
                                    :size="100"
                                    :src="streamerInfo.avatar"
                                    :fallback-src="'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNGN0Y3RjciLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxNSIgZmlsbD0iIzk5OTk5OSIvPjxwYXRoIGQ9Ik0zMCA3MEM0MCA2MCA2MCA2MCA3MCA3MEMzMCA3MCAzMCA3MCAzMCA3MFoiIGZpbGw9IiM5OTk5OTkiLz48L3N2Zz4='"
                                    round
                                />
                            </div>
                            <div class="streamer-info">
                                <h1 class="streamer-title">{{ streamerInfo.name }}</h1>
                                <n-text :depth="2" style="font-size: 1.1rem;">
                                    {{ streamerInfo.description }}
                                </n-text>
                                <div class="stats-container">
                                    <n-statistic label="歌曲" :value="totalSongs" />
                                    <n-statistic label="标签" :value="uniqueTags.length" />
                                </div>
                            </div>
                        </div>
                    </n-card>

                    <!-- 搜索和过滤控件 -->
                    <n-card class="controls-card" :bordered="false">
                        <div class="controls-header">
                            <n-text style="font-size: 1.2rem; font-weight: 600;">
                                搜索 & 筛选
                            </n-text>
                            <n-button
                                type="primary"
                                :loading="isRefreshing"
                                @click="refreshData"
                                round
                            >
                                <template #icon>
                                    <n-icon>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                        </svg>
                                    </n-icon>
                                </template>
                                {{ isRefreshing ? '刷新中...' : '刷新数据' }}
                            </n-button>
                        </div>
                        
                        <n-input
                            v-model:value="searchQuery"
                            :placeholder="isSearching ? '搜索中...' : '搜索歌曲名称或歌手...'"
                            clearable
                            round
                            size="large"
                            :loading="isSearching"
                            @input="debounceSearch"
                            @clear="clearSearch"
                            @keydown.enter="handleSearchEnter"
                        >
                            <template #prefix>
                                <n-icon>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14z"/>
                                    </svg>
                                </n-icon>
                            </template>
                        </n-input>

                        <div class="tags-container">
                            <n-tag
                                :type="selectedTag === '' ? 'primary' : 'default'"
                                checkable
                                :checked="selectedTag === ''"
                                @click="selectTag('')"
                                round
                            >
                                全部
                            </n-tag>
                            <n-tag
                                v-for="tag in uniqueTags"
                                :key="tag"
                                :type="selectedTag === tag ? 'primary' : 'default'"
                                checkable
                                :checked="selectedTag === tag"
                                @click="selectTag(tag)"
                                round
                            >
                                {{ tag }}
                            </n-tag>
                        </div>
                    </n-card>

                    <!-- 歌曲列表 -->
                    <div v-if="paginatedSongs.length > 0">
                        <div class="song-list">
                            <n-card
                                v-for="song in paginatedSongs"
                                :key="song.id"
                                class="song-card"
                                :bordered="false"
                                hoverable
                                @click="selectSong(song)"
                            >
                                <n-thing>
                                    <template #header>
                                        <n-text strong style="font-size: 1.2rem;">
                                            {{ song.title }}
                                        </n-text>
                                    </template>
                                    <template #description>
                                        <n-text :depth="2">{{ song.artist }}</n-text>
                                    </template>
                                    <template #footer>
                                        <n-space size="small">
                                            <n-tag
                                                v-for="tag in song.tags"
                                                :key="tag"
                                                size="small"
                                                round
                                            >
                                                {{ tag }}
                                            </n-tag>
                                        </n-space>
                                    </template>
                                </n-thing>
                            </n-card>
                        </div>
                        
                        <!-- 分页控件 -->
                        <n-card v-if="totalPages > 1" style="margin-top: 20px;" :bordered="false">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap;">
                                <n-text :depth="2" style="white-space: nowrap;">
                                    共 {{ totalSongsCount }} 首歌曲，第 {{ currentPage }} / {{ totalPages }} 页
                                </n-text>
                                <n-pagination
                                    v-model:page="currentPage"
                                    :page-count="totalPages"
                                    :page-size="pageSize"
                                    :show-size-picker="true"
                                    :page-sizes="[12, 24, 48, 96]"
                                    @update:page="handlePageChange"
                                    @update:page-size="handlePageSizeChange"
                                />
                            </div>
                        </n-card>
                    </div>

                    <!-- 无结果提示 -->
                    <n-card v-else-if="!initialLoading && songs.length === 0" :bordered="false">
                        <n-empty
                            description="没有找到匹配的歌曲"
                            style="margin: 40px 0;"
                        >
                            <template #extra>
                                <n-text :depth="2">
                                    {{ apiError ? '数据加载失败，请检查后端服务或点击刷新重试' : '试试其他关键词或标签吧~' }}
                                </n-text>
                            </template>
                        </n-empty>
                    </n-card>
                </div>

                <!-- 浮动按钮组 -->
                <div class="floating-actions">
                    <n-back-top
                        :visibility-height="300"
                        :listen-to="'window'"
                        style="position: static;"
                    >
                        <n-button circle size="large" type="info">
                            <template #icon>
                                <n-icon>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/>
                                    </svg>
                                </n-icon>
                            </template>
                        </n-button>
                    </n-back-top>
                    
                    <n-button
                        circle
                        size="large"
                        type="primary"
                        @click="showAdminModal"
                    >
                        <template #icon>
                            <n-icon>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                                </svg>
                            </n-icon>
                        </template>
                    </n-button>
                </div>

                <!-- 管理员登录模态框 -->
                <n-modal v-model:show="showModal" preset="dialog" title="管理员登录">
                    <template #default>
                        <n-input
                            v-model:value="adminKey"
                            type="password"
                            placeholder="请输入管理密钥"
                            show-password-on="click"
                            @keyup.enter="checkAdminKey"
                        />
                    </template>
                    <template #action>
                        <n-space>
                            <n-button @click="closeModal">取消</n-button>
                            <n-button type="primary" @click="checkAdminKey">确认</n-button>
                        </n-space>
                    </template>
                </n-modal>
            `,
            setup() {
                const message = useMessage();
                return { message };
            },
            components: {
                NCard,
                NAvatar,
                NText,
                NStatistic,
                NButton,
                NIcon,
                NInput,
                NTag,
                NThing,
                NSpace,
                NEmpty,
                NBackTop,
                NModal,
                NPagination
            },
            data() {
                return {
                    // 用户信息
                    streamerInfo: {
                        name: "歌单系统",
                        avatar: "",
                        description: "专业歌手 | 各种风格都能唱 | 欢迎点歌互动~",
                        background: ""
                    },
                    
                    // 搜索和过滤
                    searchQuery: '',
                    selectedTag: '',
                    
                    // 模态框
                    showModal: false,
                    adminKey: '',
                    
                    // 加载状态
                    isRefreshing: false,
                    initialLoading: true,
                    apiError: false,
                    
                    // 歌曲数据
                    songs: [], // 当前页的歌曲
                    allTags: [],
                    filteredSongs: [], // 保持兼容性，实际使用songs
                    
                    // 分页数据
                    currentPage: 1,
                    pageSize: 24,
                    totalSongsCount: 0,
                    totalPages: 0,
                    
                    // 搜索去抖动
                    searchTimer: null,
                    
                    // 请求控制
                    currentRequest: null,
                    isSearching: false,
                    
                    // 缓存机制
                    cache: new Map(),
                    cacheExpiry: 5 * 60 * 1000, // 5分钟缓存
                    
                    // 搜索优化
                    instantSearchMode: true, // 即时搜索模式
                    lastSearchTime: 0,
                    
                    // 模拟数据（当API不可用时使用）
                    mockSongs: [
                        {
                            id: 1,
                            title: "演员",
                            artist: "薛之谦",
                            tags: ["流行", "抒情"]
                        },
                        {
                            id: 2,
                            title: "稻香",
                            artist: "周杰伦",
                            tags: ["流行", "励志"]
                        },
                        {
                            id: 3,
                            title: "告白气球",
                            artist: "周杰伦",
                            tags: ["流行", "甜蜜"]
                        },
                        {
                            id: 4,
                            title: "夜空中最亮的星",
                            artist: "逃跑计划",
                            tags: ["摇滚", "励志"]
                        },
                        {
                            id: 5,
                            title: "消愁",
                            artist: "毛不易",
                            tags: ["民谣", "抒情"]
                        }
                    ],
                    mockTags: ["流行", "抒情", "励志", "摇滚", "民谣", "甜蜜"]
                }
            },
            
            computed: {
                uniqueTags() {
                    return this.allTags.sort();
                },
                
                totalSongs() {
                    return this.totalSongsCount;
                },
                
                // 当前页歌曲（后端分页，直接返回当前页数据）
                paginatedSongs() {
                    return this.songs;
                }
            },
            
            mounted() {
                this.applyBackground(); // 先应用默认背景
                this.initializeData();
                
                // 搜索缓存预热（延迟执行）
                setTimeout(() => {
                    this.preloadCommonSearches();
                }, 3000);
            },
            
            methods: {
                // 初始化数据
                async initializeData() {
                    this.initialLoading = true;
                    this.apiError = false;
                    
                    try {
                        // 设置3秒超时
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const [streamerResponse, tagsResponse] = await Promise.all([
                            this.fetchWithFallback('/api/streamer/profile', { signal: controller.signal }),
                            this.fetchWithFallback('/api/tags', { signal: controller.signal })
                        ]);

                        clearTimeout(timeoutId);

                        // 处理用户信息
                        if (streamerResponse && streamerResponse.ok) {
                            const streamerData = await streamerResponse.json();
                            if (streamerData.success) {
                                this.streamerInfo = {
                                    name: streamerData.data.name || this.streamerInfo.name,
                                    avatar: streamerData.data.avatar || this.streamerInfo.avatar,
                                    description: streamerData.data.description || this.streamerInfo.description,
                                    background: streamerData.data.background || this.streamerInfo.background
                                };
                                
                                // 应用背景图
                                this.applyBackground();
                            }
                        }

                        // 处理标签数据
                        if (tagsResponse && tagsResponse.ok) {
                            const tagsData = await tagsResponse.json();
                            if (tagsData.success) {
                                this.allTags = tagsData.data;
                            }
                        }

                        // 加载歌曲数据（分页）
                        await this.loadSongs();

                    } catch (error) {
                        console.error('API请求失败，使用模拟数据:', error);
                        this.apiError = true;
                        
                        // 使用模拟数据
                        this.songs = [...this.mockSongs];
                        this.allTags = [...this.mockTags];
                        this.filteredSongs = [...this.songs];
                        this.totalSongsCount = this.songs.length;
                        this.totalPages = Math.ceil(this.totalSongsCount / this.pageSize);
                        
                        // 应用默认背景
                        this.applyBackground();
                        
                        this.message.warning('无法连接到服务器，显示演示数据');
                    } finally {
                        // 确保loading状态被关闭
                        this.initialLoading = false;
                        console.log('数据初始化完成');
                    }
                },

                // 带降级的fetch
                async fetchWithFallback(url, options = {}) {
                    try {
                        return await fetch(url, options);
                    } catch (error) {
                        console.error(`Fetch failed for ${url}:`, error);
                        return null;
                    }
                },

                // 生成缓存键
                getCacheKey() {
                    return `songs_${this.currentPage}_${this.pageSize}_${this.searchQuery.trim()}_${this.selectedTag}`;
                },
                
                // 检查缓存
                getCachedData(key) {
                    if (this.cache.has(key)) {
                        const cached = this.cache.get(key);
                        if (Date.now() - cached.timestamp < this.cacheExpiry) {
                            return cached.data;
                        } else {
                            this.cache.delete(key);
                        }
                    }
                    return null;
                },
                
                // 设置缓存
                setCachedData(key, data) {
                    this.cache.set(key, {
                        data: data,
                        timestamp: Date.now()
                    });
                    
                    // 限制缓存大小
                    if (this.cache.size > 50) {
                        const firstKey = this.cache.keys().next().value;
                        this.cache.delete(firstKey);
                    }
                },

                // 加载歌曲数据（后端分页 + 缓存 + 请求取消）
                async loadSongs() {
                    try {
                        // 取消之前的请求
                        if (this.currentRequest) {
                            this.currentRequest.abort();
                        }
                        
                        this.isSearching = true;
                        
                        // 生成缓存键
                        const cacheKey = this.getCacheKey();
                        
                        // 检查缓存
                        const cachedData = this.getCachedData(cacheKey);
                        if (cachedData) {
                            this.songs = cachedData.songs || [];
                            this.totalSongsCount = cachedData.total || 0;
                            this.totalPages = cachedData.totalPages || 0;
                            this.isSearching = false;
                            console.log('使用缓存数据');
                            return;
                        }

                        // 构建API URL
                        const params = new URLSearchParams({
                            page: this.currentPage,
                            limit: this.pageSize
                        });

                        // 添加搜索参数
                        if (this.searchQuery.trim()) {
                            params.append('search', this.searchQuery.trim());
                        }

                        // 添加标签筛选
                        if (this.selectedTag) {
                            params.append('tag', this.selectedTag);
                        }

                        // 创建新的请求控制器
                        this.currentRequest = new AbortController();
                        
                        const response = await fetch(`/api/songs?${params.toString()}`, {
                            signal: this.currentRequest.signal
                        });
                        
                        if (response.status === 429) {
                            const errorData = await response.json();
                            this.message.warning(`请求过于频繁，请${errorData.retryAfter || 60}秒后再试`);
                            this.isSearching = false;
                            return;
                        }
                        
                        const data = await response.json();

                        if (data.success && data.data) {
                            const resultData = {
                                songs: data.data.songs || [],
                                total: data.data.pagination?.total || 0,
                                totalPages: data.data.pagination?.totalPages || 0
                            };
                            
                            this.songs = resultData.songs;
                            this.totalSongsCount = resultData.total;
                            this.totalPages = resultData.totalPages;
                            
                            // 缓存结果
                            this.setCachedData(cacheKey, resultData);
                            
                            console.log(`加载第${this.currentPage}页: ${this.songs.length}首歌曲，总计${this.totalSongsCount}首`);
                        } else {
                            console.error('歌曲数据加载失败:', data.error);
                            this.songs = [];
                            this.totalSongsCount = 0;
                            this.totalPages = 0;
                            if (data.error) {
                                this.message.error(data.error);
                            }
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('请求被取消');
                            return;
                        }
                        console.error('加载歌曲失败:', error);
                        this.songs = [];
                        this.totalSongsCount = 0;
                        this.totalPages = 0;
                        this.message.error('网络错误，请检查连接');
                    } finally {
                        this.isSearching = false;
                        this.currentRequest = null;
                    }
                },



                // 刷新数据
                async refreshData() {
                    if (this.isRefreshing) return;
                    
                    this.isRefreshing = true;
                    
                    try {
                        // 重置分页
                        this.currentPage = 1;
                        await this.loadSongs();
                        if (!this.apiError) {
                            this.message.success('数据刷新成功！');
                        }
                        // 刷新后重新应用背景
                        this.applyBackground();
                    } catch (error) {
                        console.error('刷新数据失败:', error);
                        this.message.error('刷新失败，请重试');
                    } finally {
                        this.isRefreshing = false;
                    }
                },

                // 应用背景图
                applyBackground() {
                    if (this.streamerInfo.background) {
                        // 使用背景图加遮罩层
                        document.body.style.background = `linear-gradient(rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)), url('${this.streamerInfo.background}') center center/cover no-repeat, linear-gradient(135deg, #667eea 0%, #764ba2 100%)`;
                    } else {
                        document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                },

                // 搜索筛选（后端搜索）
                async filterSongs() {
                    // 重置到第一页
                    this.currentPage = 1;
                    // 重新加载数据
                    await this.loadSongs();
                },
                
                // 去抖动搜索（智能优化版）
                debounceSearch() {
                    if (this.searchTimer) {
                        clearTimeout(this.searchTimer);
                    }
                    
                    // 如果搜索内容为空，立即执行
                    if (!this.searchQuery.trim()) {
                        this.filterSongs();
                        return;
                    }
                    
                    const query = this.searchQuery.trim();
                    const now = Date.now();
                    
                    // 智能延迟策略
                    let delay = this.calculateSearchDelay(query, now);
                    
                    // 即时搜索模式：对于缓存命中的查询，几乎即时响应
                    if (this.instantSearchMode && this.getCachedData(this.getCacheKey())) {
                        delay = Math.min(delay, 50); // 缓存命中时最多50ms延迟
                    }
                    
                    this.searchTimer = setTimeout(() => {
                        this.lastSearchTime = Date.now();
                        this.filterSongs();
                    }, delay);
                },
                
                // 计算搜索延迟
                calculateSearchDelay(query, now) {
                    // 基础延迟策略
                    let delay;
                    if (query.length === 1) {
                        delay = 400; // 单字符延迟
                    } else if (query.length === 2) {
                        delay = 250; // 两字符快速
                    } else {
                        delay = 150; // 多字符极速
                    }
                    
                    // 中文字符优化：中文搜索通常更精确
                    if (/[\u4e00-\u9fa5]/.test(query)) {
                        delay = Math.max(100, delay - 100);
                    }
                    
                    // 频繁搜索保护：如果用户输入很快，适当增加延迟
                    const timeSinceLastSearch = now - this.lastSearchTime;
                    if (timeSinceLastSearch < 500) {
                        delay += 100;
                    }
                    
                    return delay;
                },
                
                // 清除搜索
                async clearSearch() {
                    this.searchQuery = '';
                    await this.filterSongs();
                },
                
                // 回车立即搜索
                handleSearchEnter() {
                    // 取消去抖动延迟，立即搜索
                    if (this.searchTimer) {
                        clearTimeout(this.searchTimer);
                        this.searchTimer = null;
                    }
                    this.filterSongs();
                },
                
                // 预加载常见搜索（缓存预热）
                async preloadCommonSearches() {
                    if (this.apiError) return; // 如果API有问题就不预加载
                    
                    console.log('开始搜索缓存预热...');
                    const commonSearches = ['周', '王', '李', '张', '林', '陈', '流行', '摇滚'];
                    
                    for (const search of commonSearches) {
                        try {
                            // 静默预加载，不影响用户界面
                            const controller = new AbortController();
                            setTimeout(() => controller.abort(), 2000); // 2秒超时
                            
                            const params = new URLSearchParams({
                                page: 1,
                                limit: 24,
                                search: search
                            });
                            
                            const response = await fetch(`/api/songs?${params.toString()}`, {
                                signal: controller.signal
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.success && data.data) {
                                    // 存入缓存
                                    const cacheKey = `songs_1_24_${search}_`;
                                    this.setCachedData(cacheKey, {
                                        songs: data.data.songs || [],
                                        total: data.data.pagination?.total || 0,
                                        totalPages: data.data.pagination?.totalPages || 0
                                    });
                                }
                            }
                            
                            // 避免请求过于频繁
                            await new Promise(resolve => setTimeout(resolve, 300));
                        } catch (error) {
                            if (error.name !== 'AbortError') {
                                console.warn('预加载搜索失败:', search, error);
                            }
                        }
                    }
                    
                    console.log('搜索缓存预热完成');
                },
                
                async selectTag(tag) {
                    this.selectedTag = tag;
                    await this.filterSongs();
                },
                
                // 分页处理方法
                async handlePageChange(page) {
                    this.currentPage = page;
                    await this.loadSongs();
                    // 滚动到顶部
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                
                async handlePageSizeChange(pageSize) {
                    this.pageSize = pageSize;
                    this.currentPage = 1; // 重置到第一页
                    await this.loadSongs();
                    // 滚动到顶部
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                
                selectSong(song) {
                    const songText = `${song.title} - ${song.artist}`;
                    this.copyToClipboard(songText);
                },
                
                async copyToClipboard(text) {
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(text);
                            this.message.success(`已复制：${text}`);
                        } else {
                            this.fallbackCopyTextToClipboard(text);
                        }
                    } catch (err) {
                        console.error('复制失败:', err);
                        this.fallbackCopyTextToClipboard(text);
                    }
                },
                
                fallbackCopyTextToClipboard(text) {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-999999px";
                    textArea.style.top = "-999999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            this.message.success(`已复制：${text}`);
                        } else {
                            this.message.error('复制失败，请手动复制');
                        }
                    } catch (err) {
                        console.error('降级复制方案失败:', err);
                        this.message.error('复制失败，请手动复制');
                    }
                    
                    document.body.removeChild(textArea);
                },
                
                showAdminModal() {
                    // 检查是否已登录
                    const token = sessionStorage.getItem('admin_token');
                    const authTime = sessionStorage.getItem('admin_auth_time');
                    
                    // 检查token是否存在且在有效期内（24小时）
                    if (token && authTime) {
                        const now = Date.now();
                        const loginTime = parseInt(authTime);
                        const twentyFourHours = 24 * 60 * 60 * 1000;
                        
                        if (now - loginTime < twentyFourHours) {
                            // 已登录且token有效，直接跳转
                            this.message.success('正在跳转到管理后台...');
                            setTimeout(() => {
                                window.location.href = '/admin';
                            }, 500);
                            return;
                        } else {
                            // token过期，清除
                            sessionStorage.removeItem('admin_token');
                            sessionStorage.removeItem('admin_auth_time');
                        }
                    }
                    
                    // 未登录或token过期，显示登录框
                    this.showModal = true;
                    this.adminKey = '';
                },
                
                closeModal() {
                    this.showModal = false;
                    this.adminKey = '';
                },
                
                async checkAdminKey() {
                    if (!this.adminKey.trim()) {
                        this.message.error('请输入管理密钥');
                        return;
                    }

                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ key: this.adminKey })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.closeModal();
                            // 存储token到sessionStorage
                            sessionStorage.setItem('admin_token', data.token);
                            sessionStorage.setItem('admin_auth_time', Date.now().toString());
                            this.message.success('登录成功！即将跳转到管理后台...');
                            // 跳转到管理后台
                            setTimeout(() => {
                                window.location.href = '/admin';
                            }, 1000);
                        } else {
                            this.message.error(data.error || '登录失败');
                            this.adminKey = '';
                        }
                    } catch (error) {
                        console.error('管理员登录失败:', error);
                        this.message.error('登录失败，请检查网络连接');
                        this.adminKey = '';
                    }
                }
            }
        };

        // 站点设置管理
        const SiteManager = {
            // 缓存的设置
            _settings: null,
            
            // 初始化站点设置
            async init() {
                try {
                    const response = await fetch('/api/site/settings');
                    const data = await response.json();
                    
                    if (data.success) {
                        this._settings = data.data;
                        // 立即应用设置
                        this.applySiteSettings();
                        console.log('站点设置初始化完成:', {
                            title: this._settings.site_title,
                            hasFavicon: !!this._settings.site_favicon,
                            defaults: this._settings._defaults
                        });
                    } else {
                        console.warn('站点设置API返回失败，使用系统默认设置');
                        this.applyFallbackSettings();
                    }
                } catch (error) {
                    console.error('站点设置初始化失败，使用系统默认设置:', error);
                    this.applyFallbackSettings();
                }
            },
            
            // 应用站点设置
            applySiteSettings() {
                if (!this._settings) return;
                
                // 设置页面标题
                document.title = this._settings.site_title;
                
                // 设置favicon
                this.updateFavicon(this._settings.site_favicon);
            },
            
            // 应用回退设置（硬编码的默认值）
            applyFallbackSettings() {
                document.title = '歌单系统';
                this.updateFavicon('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzY2N2VlYSIvPgo8cGF0aCBkPSJNOCAxMGg2djJIOHYtMnptMCA0aDZ2Mkg4di0yem0wIDRoNHYySDB2LTJ6bTEwLThIMjZ2MkgxOFY2em0wIDRoOHYySDE4di0yem0wIDRoNnYySDE4di0yeiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+');
            },
            
            updateFavicon(faviconUrl) {
                // 移除现有的favicon
                const existingFavicon = document.querySelector('link[rel="icon"]');
                if (existingFavicon) {
                    existingFavicon.remove();
                }
                
                // 添加新的favicon
                const link = document.createElement('link');
                link.rel = 'icon';
                link.type = 'image/x-icon';
                link.href = faviconUrl;
                document.head.appendChild(link);
            }
        };

        createApp({
            components: {
                NConfigProvider,
                NMessageProvider: naive.NMessageProvider,
                AppContent
            },
            data() {
                return {
                    theme: null,
                    themeOverrides: {
                        common: {
                            primaryColor: '#667eea',
                            primaryColorHover: '#5a6fd8',
                            primaryColorPressed: '#4d60c4',
                            infoColor: '#42a5f5',
                            infoColorHover: '#2196f3',
                            infoColorPressed: '#1976d2',
                            successColor: '#5c6bc0',
                            successColorHover: '#3f51b5',
                            successColorPressed: '#303f9f',
                            warningColor: '#ab47bc',
                            warningColorHover: '#9c27b0',
                            warningColorPressed: '#7b1fa2'
                        },
                        Tag: {
                            colorPrimary: '#667eea',
                            colorPrimaryHover: '#5a6fd8',
                            textColorPrimary: '#ffffff',
                            colorDefault: 'rgba(102, 126, 234, 0.1)',
                            colorDefaultHover: 'rgba(102, 126, 234, 0.2)',
                            textColorDefault: '#667eea'
                        },
                        Button: {
                            colorPrimary: '#667eea',
                            colorPrimaryHover: '#5a6fd8',
                            colorPrimaryPressed: '#4d60c4',
                            colorInfo: '#42a5f5',
                            colorInfoHover: '#2196f3',
                            colorInfoPressed: '#1976d2',
                            colorSuccess: '#5c6bc0',
                            colorSuccessHover: '#3f51b5',
                            colorSuccessPressed: '#303f9f'
                        },
                        Card: {
                            colorEmbedded: 'rgba(255, 255, 255, 0.95)',
                            colorEmbeddedModal: 'rgba(255, 255, 255, 0.98)'
                        },
                        Input: {
                            borderHover: '#667eea',
                            borderFocus: '#667eea',
                            boxShadowFocus: '0 0 0 2px rgba(102, 126, 234, 0.2)'
                        }
                    }
                }
            },
            async mounted() {
                // 初始化站点设置（一次性加载并应用）
                await SiteManager.init();
            }
        }).mount('#app');
    </script>
</body>
</html>